<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            body {
                padding: 10px;
                font-family: var(--vscode-font-family);
                color: var(--vscode-foreground);
            }
            .breadcrumb {
                padding: 10px;
                background-color: var(--vscode-editor-background);
                border-bottom: 1px solid var(--vscode-panel-border);
                margin-bottom: 20px;
            }
            .breadcrumb a {
                color: var(--vscode-textLink-foreground);
                text-decoration: none;
            }
            .breadcrumb a:hover {
                text-decoration: underline;
            }
            .breadcrumb span {
                color: var(--vscode-descriptionForeground);
                margin: 0 8px;
            }
            .sql-editor {
                width: 100%;
                height: 100px;
                margin: 10px 0;
                padding: 8px;
                background-color: var(--vscode-input-background);
                color: var(--vscode-input-foreground);
                border: 1px solid var(--vscode-input-border);
                font-family: var(--vscode-editor-font-family);
            }
            .section {
                margin: 20px 0;
                padding: 15px 0;
            }
            .section h3 {
                margin-top: 0;
                color: var(--vscode-sideBarTitle-foreground);
                font-size: 1.1em;
                margin-bottom: 15px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                padding: 8px;
                border: 1px solid var(--vscode-panel-border);
                text-align: left;
            }
            th {
                background-color: var(--vscode-editor-background);
                font-weight: normal;
                color: var(--vscode-foreground);
            }
            .execute-btn {
                background-color: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
                border: none;
                padding: 8px 16px;
                cursor: pointer;
            }
            .execute-btn:hover {
                background-color: var(--vscode-button-hoverBackground);
            }
            #queryResult .error {
                color: var(--vscode-errorForeground);
                padding: 10px;
                margin: 10px 0;
                background-color: var(--vscode-inputValidation-errorBackground);
                border: 1px solid var(--vscode-inputValidation-errorBorder);
            }
            #queryResultContent {
                position: relative;
                overflow: auto;
                max-height: 70vh;
                width: 100%;
            }
            #queryResultContent table {
                margin-top: 0;
                border-collapse: separate;
                border-spacing: 0;
                width: 100%;
            }
            #queryResultContent thead {
                position: sticky;
                top: 0;
                z-index: 1;
                background-color: var(--vscode-editor-background);
            }
            #queryResultContent th {
                position: sticky;
                top: 0;
                background-color: var(--vscode-editor-background);
                border-bottom: 2px solid var(--vscode-panel-border);
                white-space: nowrap;
                padding: 8px 16px;
            }
            #queryResultContent td {
                padding: 8px 16px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border: 1px solid var(--vscode-panel-border);
                cursor: pointer;
                position: relative;
                transition: all 0.3s;
                max-width: 300px;
            }
            #queryResultContent td:hover {
                position: relative;
                white-space: pre-wrap !important;
                word-break: break-word !important;
                max-width: none !important;
                background-color: var(--vscode-list-hoverBackground);
                z-index: 10;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            #queryResultContent td:active {
                background-color: var(--vscode-editor-selectionBackground);
            }
            #queryResultContent td::after {
                content: "Copied!";
                position: absolute;
                top: -30px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--vscode-editor-background);
                color: var(--vscode-foreground);
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                border: 1px solid var(--vscode-panel-border);
                opacity: 0;
                transition: opacity 0.2s;
                pointer-events: none;
                z-index: 100;
            }
            #queryResultContent td.copied::after {
                opacity: 1;
            }
            .tabs {
                margin: 20px 0 0 0;
            }
            .tab-buttons {
                display: flex;
                border-bottom: 1px solid var(--vscode-panel-border);
                margin-bottom: 15px;
            }
            .tab-button {
                padding: 8px 16px;
                border: none;
                background: none;
                color: var(--vscode-foreground);
                cursor: pointer;
                margin-right: 2px;
                position: relative;
            }
            .tab-button.active {
                color: var(--vscode-textLink-foreground);
                font-weight: 500;
            }
            .tab-button.active::after {
                content: "";
                position: absolute;
                bottom: -1px;
                left: 0;
                right: 0;
                height: 2px;
                background-color: var(--vscode-textLink-foreground);
            }
            .tab-button:hover:not(.active) {
                color: var(--vscode-textLink-activeForeground);
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 0;
            }
            .tab-header {
                margin-bottom: 15px;
                padding: 10px;
                background-color: var(--vscode-editor-background);
                border: 1px solid var(--vscode-panel-border);
                border-radius: 3px;
            }
            .tab-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            .display-mode {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .query-actions {
                display: flex;
                gap: 8px;
            }
            .display-mode select {
                padding: 4px 8px;
                background-color: var(--vscode-dropdown-background);
                color: var(--vscode-dropdown-foreground);
                border: 1px solid var(--vscode-dropdown-border);
                border-radius: 2px;
            }
            .vertical-row {
                background: var(--vscode-editor-background);
                border-radius: 4px;
                margin-bottom: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            .vertical-row:last-child {
                margin-bottom: 0;
            }
            .vertical-row-header {
                padding: 8px 12px;
                background: var(--vscode-sideBarSectionHeader-background);
                color: var(--vscode-sideBarSectionHeader-foreground);
                font-size: 0.9em;
                border-bottom: 1px solid var(--vscode-panel-border);
                border-radius: 4px 4px 0 0;
            }
            .vertical-table {
                width: 100%;
                border: 1px solid var(--vscode-panel-border);
                border-radius: 0 0 4px 4px;
                border-spacing: 0;
            }
            .vertical-table tr {
                display: flex;
            }
            .vertical-table tr:not(:last-child) {
                border-bottom: 1px solid var(--vscode-panel-border);
            }
            .vertical-table td {
                padding: 8px 12px;
                line-height: 1.4;
                border: none;
            }
            .vertical-table td:first-child {
                flex: 0 0 200px;
                background: var(--vscode-editor-background);
                color: var(--vscode-foreground);
                font-weight: 500;
                border-right: 1px solid var(--vscode-panel-border);
            }
            .vertical-table td:last-child {
                flex: 1;
                background: var(--vscode-input-background);
                color: var(--vscode-input-foreground);
            }
            .row-number {
                color: var(--vscode-descriptionForeground);
                font-size: 0.9em;
            }
            .null-value {
                color: var(--vscode-descriptionForeground);
                font-style: italic;
            }
            .vertical-table td:last-child {
                white-space: pre-wrap;
                word-break: break-word;
            }
            .table-info-grid {
                display: grid;
                grid-template-columns: 180px 1fr;
                gap: 8px;
                margin-bottom: 20px;
            }
            .table-info-label {
                font-weight: 500;
                color: var(--vscode-foreground);
                padding: 4px 8px;
            }
            .table-info-value {
                padding: 4px 8px;
            }
            .table-info-action {
                color: var(--vscode-textLink-foreground);
                cursor: pointer;
                margin-left: 8px;
            }
            .table-info-action:hover {
                text-decoration: underline;
            }
            .create-syntax {
                font-family: monospace;
                white-space: pre-wrap;
                padding: 12px;
                background-color: var(--vscode-editor-background);
                border: 1px solid var(--vscode-panel-border);
                margin-top: 12px;
            }
            .query-history-item {
                padding: 12px;
                border-bottom: 1px solid var(--vscode-panel-border);
            }
            .query-history-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
            }
            .query-history-time {
                font-size: 0.9em;
                color: var(--vscode-descriptionForeground);
            }
            .query-history-status {
                font-size: 0.85em;
                padding: 2px 6px;
                border-radius: 3px;
                font-weight: 500;
            }
            .query-history-status.pending {
                background-color: var(--vscode-badge-background);
                color: var(--vscode-badge-foreground);
            }
            .query-history-status.success {
                background-color: var(--vscode-testing-iconPassed);
                color: var(--vscode-editor-background);
            }
            .query-history-status.error {
                background-color: var(--vscode-testing-iconFailed);
                color: var(--vscode-editor-background);
            }
            .query-history-sql {
                font-family: var(--vscode-editor-font-family);
                white-space: pre-wrap;
                word-break: break-word;
                padding: 8px;
                background-color: var(--vscode-editor-background);
                border-radius: 4px;
                cursor: pointer;
            }
            .query-history-sql:hover {
                background-color: var(--vscode-list-hoverBackground);
            }
            .action-btn {
                background-color: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
                border: 1px solid var(--vscode-button-border);
                padding: 4px 12px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                height: 24px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 80px;
            }
            .action-btn:hover {
                background-color: var(--vscode-button-secondaryHoverBackground);
            }
        </style>
    </head>
    <body>
        <div class="breadcrumb">
            <a href="#" onclick="return false;">{{connectionName}}</a>
            <span>></span>
            <a href="#" onclick="return false;">{{database}}</a>
            <span>></span>
            <a href="#" onclick="return false;">{{table}}</a>
        </div>

        <div class="section">
            <textarea
                class="sql-editor"
                id="sqlEditor"
                placeholder="Enter your SQL query here..."
            >
SELECT * FROM {{table}} LIMIT 10;</textarea
            >
            <button class="execute-btn" onclick="executeQuery()">
                Execute
            </button>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button
                    class="tab-button active"
                    onclick="showTab('table-info')"
                >
                    Table Info
                </button>
                <button class="tab-button" onclick="showTab('structure')">
                    Table Structure
                </button>
                <button class="tab-button" onclick="showTab('indexes')">
                    Indexes
                </button>
                <button class="tab-button" onclick="showTab('query-result')">
                    Query Result
                </button>
                <button class="tab-button" onclick="showTab('query-history')">
                    Query History
                </button>
            </div>

            <div id="table-info" class="tab-content active">
                <div class="table-info-grid">
                    <div class="table-info-label">Type:</div>
                    <div class="table-info-value">{{tableInfo.engine}}</div>

                    <div class="table-info-label">Encoding:</div>
                    <div class="table-info-value">
                        {{tableInfo.charset}}
                        <span
                            class="table-info-action"
                            onclick="modifyEncoding()"
                            >Modify</span
                        >
                    </div>

                    <div class="table-info-label">Created at:</div>
                    <div class="table-info-value">
                        {{tableInfo.create_time}}
                    </div>

                    <div class="table-info-label">Updated at:</div>
                    <div class="table-info-value">
                        {{tableInfo.update_time}}
                    </div>

                    <div class="table-info-label">Number of rows:</div>
                    <div class="table-info-value">{{tableInfo.rows}}</div>

                    <div class="table-info-label">Row format:</div>
                    <div class="table-info-value">{{tableInfo.row_format}}</div>

                    <div class="table-info-label">Avg. row length:</div>
                    <div class="table-info-value">
                        {{tableInfo.avg_row_length}} B
                    </div>

                    <div class="table-info-label">Auto increment:</div>
                    <div class="table-info-value">
                        {{tableInfo.auto_increment}} {{#if
                        tableInfo.auto_increment}}
                        <span
                            class="table-info-action"
                            onclick="resetAutoIncrement()"
                            >Reset</span
                        >
                        {{/if}}
                    </div>

                    <div class="table-info-label">Data size:</div>
                    <div class="table-info-value">
                        {{tableInfo.data_length}} B
                    </div>

                    <div class="table-info-label">Max data size:</div>
                    <div class="table-info-value">
                        {{tableInfo.max_data_length}} B
                    </div>

                    <div class="table-info-label">Index size:</div>
                    <div class="table-info-value">
                        {{tableInfo.index_length}} B
                    </div>

                    <div class="table-info-label">Free data size:</div>
                    <div class="table-info-value">
                        {{tableInfo.data_free}} B
                    </div>
                </div>

                <h3>Create Table Syntax:</h3>
                <div class="create-syntax">{{tableInfo.create_syntax}}</div>
            </div>

            <div id="structure" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Null</th>
                            <th>Key</th>
                            <th>Default</th>
                            <th>Extra</th>
                            <th>Comment</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each columnInfo}}
                        <tr>
                            <td>{{Field}}</td>
                            <td>{{Type}}</td>
                            <td>{{Null}}</td>
                            <td>{{Key}}</td>
                            <td>{{Default}}</td>
                            <td>{{Extra}}</td>
                            <td>{{Comment}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <div id="indexes" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Key Name</th>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Unique</th>
                            <th>Packed</th>
                            <th>Cardinality</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each indexInfo}}
                        <tr>
                            <td>{{Key_name}}</td>
                            <td>{{Column_name}}</td>
                            <td>{{Index_type}}</td>
                            <td>{{#if Non_unique}}No{{else}}Yes{{/if}}</td>
                            <td>{{Packed}}</td>
                            <td>{{Cardinality}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <div id="query-result" class="tab-content">
                <div class="tab-header">
                    <div class="tab-header-row">
                        <div class="query-actions">
                            <button class="action-btn" onclick="copyAsJson()">
                                Copy as JSON
                            </button>
                            <button class="action-btn" onclick="copyAsInsert()">
                                Copy as Insert
                            </button>
                            <button
                                class="action-btn"
                                onclick="downloadAsCsv()"
                            >
                                Download as CSV
                            </button>
                            <button
                                class="action-btn"
                                onclick="downloadAsSql()"
                            >
                                Download as SQL
                            </button>
                        </div>
                        <div class="display-mode">
                            <label>Display Mode:</label>
                            <select
                                id="displayMode"
                                onchange="toggleDisplayMode()"
                            >
                                <option value="horizontal">Horizontal</option>
                                <option value="vertical">Vertical</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="queryResultContent"></div>
            </div>

            <div id="query-history" class="tab-content">
                <div class="query-history-list"></div>
            </div>
        </div>

        <script>
            const vscode = acquireVsCodeApi();
            let currentData = null;
            let queryHistory = [];

            function showTab(tabId) {
                document.querySelectorAll(".tab-content").forEach((tab) => {
                    tab.classList.remove("active");
                });
                document.querySelectorAll(".tab-button").forEach((button) => {
                    button.classList.remove("active");
                });

                document.getElementById(tabId).classList.add("active");
                document
                    .querySelector(`.tab-button[onclick="showTab('${tabId}')"]`)
                    .classList.add("active");
            }

            function executeQuery() {
                const sql = document.getElementById("sqlEditor").value;
                const resultContent =
                    document.getElementById("queryResultContent");
                const timestamp = new Date();

                resultContent.innerHTML = "Executing query...";
                showTab("query-result");

                const historyEntry = {
                    sql: sql,
                    timestamp: timestamp,
                    status: "pending",
                };
                queryHistory.unshift(historyEntry);
                updateQueryHistory();

                vscode.postMessage({
                    command: "executeQuery",
                    sql: sql,
                });
            }

            function toggleDisplayMode() {
                if (!currentData) return;
                const mode = document.getElementById("displayMode").value;
                renderQueryResult(currentData, mode);
            }

            function renderQueryResult(data, mode = "horizontal") {
                const resultContent =
                    document.getElementById("queryResultContent");
                const queryActions = document.querySelector(".query-actions");

                // 初始化时显示按钮
                queryActions.style.display = "flex";

                if (!data || !data.rows || data.rows.length === 0) {
                    resultContent.innerHTML = "No results found";
                    return;
                }

                if (mode === "horizontal") {
                    renderHorizontalTable(data, resultContent);
                } else {
                    renderVerticalTable(data, resultContent);
                }
            }

            function renderHorizontalTable(data, container) {
                let table = "<table><thead><tr>";
                data.columns.forEach((column) => {
                    table += `<th>${column}</th>`;
                });
                table += "</tr></thead><tbody>";

                data.rows.forEach((row) => {
                    table += "<tr>";
                    data.columns.forEach((column) => {
                        const value = row[column];
                        const displayValue = value === null ? "NULL" : value;
                        const escapedValue = String(displayValue)
                            .replace(/'/g, "\\'")
                            .replace(/"/g, '\\"')
                            .replace(/\\/g, "\\\\");
                        table += `<td onclick="copyTableCell(this, '${escapedValue}')">${displayValue}</td>`;
                    });
                    table += "</tr>";
                });

                table += "</tbody></table>";
                container.innerHTML = table;
            }

            function renderVerticalTable(data, container) {
                let html = "";

                data.rows.forEach((row, rowIndex) => {
                    html += `<div class="vertical-row">
                    <div class="vertical-row-header">
                        <span class="row-number">Record ${rowIndex + 1} of ${
                        data.rows.length
                    }</span>
                    </div>
                    <table class="vertical-table">`;

                    data.columns.forEach((column) => {
                        const value = row[column];
                        const displayValue =
                            value === null
                                ? '<span class="null-value">NULL</span>'
                                : value;
                        const escapedValue = String(
                            value === null ? "NULL" : value
                        )
                            .replace(/'/g, "\\'")
                            .replace(/"/g, '\\"');
                        html += `<tr>
                        <td>${column}</td>
                        <td onclick="copyTableCell(this, '${escapedValue}')">${displayValue}</td>
                    </tr>`;
                    });

                    html += `</table></div>`;
                });

                container.innerHTML = html;
            }

            function copyTableCell(cell, value) {
                // 确保值不为 null
                const textValue = value === null ? "NULL" : value;

                // 复制到剪贴板
                copyToClipboard(textValue, "Cell content copied to clipboard");
            }

            function formatBytes(bytes) {
                if (!bytes || bytes === 0) return "0 B";
                const k = 1024;
                const sizes = ["B", "KiB", "MiB", "GiB", "TiB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (
                    parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                    " " +
                    sizes[i]
                );
            }

            function modifyEncoding() {
                vscode.postMessage({
                    command: "modifyEncoding",
                    table: "{{table}}",
                });
            }

            function resetAutoIncrement() {
                vscode.postMessage({
                    command: "resetAutoIncrement",
                    table: "{{table}}",
                });
            }

            function updateQueryHistory() {
                const container = document.querySelector(".query-history-list");
                container.innerHTML = queryHistory
                    .map(
                        (entry, index) => `
                <div class="query-history-item">
                    <div class="query-history-header">
                        <div class="query-history-time">${entry.timestamp.getFullYear()}-${String(
                            entry.timestamp.getMonth() + 1
                        ).padStart(2, "0")}-${String(
                            entry.timestamp.getDate()
                        ).padStart(2, "0")} ${String(
                            entry.timestamp.getHours()
                        ).padStart(2, "0")}:${String(
                            entry.timestamp.getMinutes()
                        ).padStart(2, "0")}:${String(
                            entry.timestamp.getSeconds()
                        ).padStart(2, "0")}</div>
                        <div class="query-history-status ${
                            entry.status === "pending"
                                ? "pending"
                                : entry.status === "error"
                                ? "error"
                                : "success"
                        }">
                            ${
                                entry.status === "pending"
                                    ? "Executing"
                                    : entry.status === "error"
                                    ? "Failed"
                                    : "Success"
                            }
                        </div>
                    </div>
                    <div class="query-history-sql" onclick="copySqlToClipboard(${index})">${
                            entry.sql
                        }</div>
                </div>
            `
                    )
                    .join("");
            }

            function copySqlToClipboard(index) {
                const entry = queryHistory[index];
                const textarea = document.createElement("textarea");
                textarea.value = entry.sql;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);

                const sqlElement =
                    document.querySelectorAll(".query-history-sql")[index];
                const originalBackground = sqlElement.style.backgroundColor;
                sqlElement.style.backgroundColor =
                    "var(--vscode-editor-selectionBackground)";
                setTimeout(() => {
                    sqlElement.style.backgroundColor = originalBackground;
                }, 200);

                vscode.postMessage({
                    command: "showInfo",
                    text: "SQL copied to clipboard",
                });
            }

            function copyAsJson() {
                if (!currentData || !currentData.rows) return;
                const jsonStr = JSON.stringify(currentData.rows, null, 2);
                copyToClipboard(jsonStr, "JSON data copied to clipboard");
            }

            function copyAsInsert() {
                if (
                    !currentData ||
                    !currentData.rows ||
                    currentData.rows.length === 0
                )
                    return;

                const table =
                    document
                        .getElementById("sqlEditor")
                        .value.match(/FROM\s+`?(\w+)`?/i)?.[1] || "{{table}}";
                let insertSql = currentData.rows
                    .map((row) => {
                        const columns = Object.keys(row);
                        const values = columns.map((col) => {
                            const val = row[col];
                            if (val === null) return "NULL";
                            if (typeof val === "number") return val;
                            return `'${val.toString().replace(/'/g, "''")}'`;
                        });

                        return `INSERT INTO \`${table}\` (\`${columns.join(
                            "`, `"
                        )}\`) VALUES (${values.join(", ")});`;
                    })
                    .join("\n");

                copyToClipboard(
                    insertSql,
                    "Insert statement copied to clipboard"
                );
            }

            function downloadAsCsv() {
                if (
                    !currentData ||
                    !currentData.rows ||
                    currentData.rows.length === 0
                )
                    return;

                const columns = currentData.columns;
                const csvContent = [
                    columns.join(","),
                    ...currentData.rows.map((row) =>
                        columns
                            .map((col) => {
                                const val = row[col];
                                if (val === null) return "";
                                if (
                                    typeof val === "string" &&
                                    val.includes(",")
                                ) {
                                    return `"${val.replace(/"/g, '""')}"`;
                                }
                                return val;
                            })
                            .join(",")
                    ),
                ].join("\n");

                downloadFile(csvContent, "query_result.csv", "text/csv");
            }

            function downloadAsSql() {
                if (
                    !currentData ||
                    !currentData.rows ||
                    currentData.rows.length === 0
                )
                    return;

                const table =
                    document
                        .getElementById("sqlEditor")
                        .value.match(/FROM\s+`?(\w+)`?/i)?.[1] || "{{table}}";
                let sqlContent = "-- Generated SQL Insert Statements\n\n";

                currentData.rows.forEach((row) => {
                    const columns = Object.keys(row);
                    const values = columns.map((col) => {
                        const val = row[col];
                        if (val === null) return "NULL";
                        if (typeof val === "number") return val;
                        return `'${val.toString().replace(/'/g, "''")}'`;
                    });

                    sqlContent += `INSERT INTO \`${table}\` (\`${columns.join(
                        "`, `"
                    )}\`) VALUES (${values.join(", ")});\n`;
                });

                downloadFile(sqlContent, "query_result.sql", "text/plain");
            }

            function copyToClipboard(text, successMessage) {
                const textarea = document.createElement("textarea");
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);

                vscode.postMessage({
                    command: "showInfo",
                    text: successMessage,
                });
            }

            function downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);

                vscode.postMessage({
                    command: "showInfo",
                    text: `File downloaded: ${filename}`,
                });
            }

            window.addEventListener("message", (event) => {
                const message = event.data;

                switch (message.command) {
                    case "queryResult":
                        currentData = message.data;
                        if (queryHistory.length > 0) {
                            queryHistory[0].status = "success";
                            updateQueryHistory();
                        }
                        const mode =
                            document.getElementById("displayMode").value;
                        renderQueryResult(currentData, mode);
                        break;

                    case "queryError":
                        if (queryHistory.length > 0) {
                            queryHistory[0].status = "error";
                            queryHistory[0].error = message.error;
                            updateQueryHistory();
                        }
                        document.getElementById(
                            "queryResultContent"
                        ).innerHTML = `<div class="error">${message.error}</div>`;
                        break;
                }
            });
        </script>
    </body>
</html>
